#!/usr/bin/env node

/**
 * Script to update all code references to i18n keys after translation file refactoring
 * This script uses the mapping file generated by fix-i18n-snake-case.js
 * to update all t("old_key") references to t("new_key")
 */

const fs = require("fs");
const path = require("path");
const { execSync } = require("child_process");

const mappingFile = path.join(__dirname, "i18n-key-mapping-snake-case.json");

if (!fs.existsSync(mappingFile)) {
  console.error(`❌ Mapping file not found: ${mappingFile}`);
  console.error("   Please run fix-i18n-snake-case.js first");
  process.exit(1);
}

const keyMapping = JSON.parse(fs.readFileSync(mappingFile, "utf8"));

console.log(`Found ${Object.keys(keyMapping).length} keys to update in code`);

// Find all TypeScript/TSX files
const srcDir = path.join(__dirname, "../src");
const files = execSync(
  `find ${srcDir} -type f \\( -name "*.ts" -o -name "*.tsx" \\)`,
  { encoding: "utf8" }
)
  .trim()
  .split("\n")
  .filter(Boolean);

let totalReplacements = 0;

for (const filePath of files) {
  try {
    let content = fs.readFileSync(filePath, "utf8");
    let fileModified = false;
    let fileReplacements = 0;

    // Update t("old_key") to t("new_key")
    for (const [oldKey, newKey] of Object.entries(keyMapping)) {
      // Pattern: t("old_key") or t('old_key')
		const patterns = [
        new RegExp(`t\\(\"${oldKey.replace(/[.*+?^${}()|[\]\\]/g, "\\$&")}\"\\)`, "g"),
        new RegExp(`t\\('${oldKey.replace(/[.*+?^${}()|[\]\\]/g, "\\$&")}'\\)`, "g"),
		];
		
		for (const pattern of patterns) {
        const matches = content.match(pattern);
        if (matches) {
				content = content.replace(pattern, (match) => {
					return match.replace(oldKey, newKey);
				});
          fileReplacements += matches.length;
          fileModified = true;
        }
      }
    }

    if (fileModified) {
      fs.writeFileSync(filePath, content, "utf8");
      totalReplacements += fileReplacements;
      console.log(`  ✅ ${filePath}: ${fileReplacements} replacements`);
    }
  } catch (error) {
    console.error(`  ❌ Error processing ${filePath}:`, error.message);
  }
}

console.log(`\n✅ Total replacements: ${totalReplacements}`);
console.log(`\n⚠️  Please review the changes and test the application`);
