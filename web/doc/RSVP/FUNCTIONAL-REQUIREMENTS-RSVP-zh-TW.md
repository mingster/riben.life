# 功能需求：RSVP 系統

**日期：** 2025-01-27
**狀態：** 進行中
**版本：** 1.5

**相關文件：**

- [PRD-restaurant-reservation.md](./PRD-restaurant-reservation.md)
- [TECHNICAL-REQUIREMENTS-RSVP.md](./TECHNICAL-REQUIREMENTS-RSVP.md)
- [GITHUB-ISSUES-CHECKLIST.md](./GITHUB-ISSUES-CHECKLIST.md)

---

## 1. 概述

RSVP（預約/約會）系統使任何企業都能接受、管理和追蹤客戶的預約和約會。系統設計靈活，可用於各種業務類型，包括餐廳、沙龍、診所、服務提供商，以及任何需要預約排程的企業。系統支援線上預約、LINE 預約、候補名單、通知，以及與外部平台的整合，包括 Reserve with Google（Google 的預約服務）、Google Maps 和 LINE。

**注意：** 在本文件中，「設施」和「已就座」等術語是通用用法。對於餐廳而言，「設施」指的是餐桌。對於其他企業，「設施」可能代表服務站、治療室、諮詢室或其他可預訂的資源。「已就座」可能表示「已到達」或「服務已開始」，具體取決於業務情境。

---

## 2. 系統角色

### 2.1 客戶

- 匿名訪客（無需帳號）
- 註冊用戶（有帳號）
- LINE 用戶（透過 LINE Login）

### 2.2 店長

- 店家主
- 對店面設定和配置擁有完整的管理權限
- 可以管理 RSVP 系統的所有功能

### 2.3 店員

- 擁有操作權限的店面員工
- 可以管理預約和客戶互動
- 對設定的存取受限（由店長配置）

### 2.4 系統管理員

- 平台管理員

---

## 2.5 存取控制摘要

### 店員權限（操作存取）

店員可以：

- 為客戶建立預約
- 查看所有預約
- 編輯預約
- 確認預約
- 標記預約狀態（已就座、未到、已完成）
- 取消預約
- 查看和管理候補名單
- 查看資源狀態
- 手動分配資源
- 查看客戶簽名
- 發送 LINE 廣播訊息
- 查看標籤（但無法建立/管理）

店員不能：

- 配置 RSVP 設定
- 建立/管理資源（設施）
- 管理黑名單
- 建立/管理標籤
- 查看分析和報表
- 覆蓋取消限制（除非由店長配置）

### 店長權限（完整管理存取）

店長擁有所有店員權限，此外還包括：

- 配置所有 RSVP 設定
- 建立和管理資源（設施）
- 管理客戶黑名單
- 建立和管理客戶標籤
- 查看分析和報表
- 覆蓋取消限制
- 配置店員存取權限

---

## 3. 核心功能需求

### 3.1 預約建立

#### 3.1.1 線上預約（客戶端）

**FR-RSVP-001：** 客戶必須能夠透過店面的公開 RSVP 頁面建立預約。

**FR-RSVP-002：** 預約表單必須收集以下資訊：

- 預約日期和時間（rsvpTime）
- 成人人數（numOfAdult，預設值：1）
- 兒童人數（numOfChild，預設值：0）
- 客戶聯絡資訊：
  - 用戶 ID（如果已登入，選填）
  - 電子郵件地址（未登入時必填）
  - 電話號碼（選填）
- 特殊要求或備註（message，選填）
- 設施偏好（facilityId，選填）

**注意：** 如果需要預付費（`prepaidRequired = true`），客戶必須登入才能建立預約。

**FR-RSVP-003：** 系統必須根據以下條件驗證預約可用性：

- 店面的 RSVP 設定（acceptReservation 標記）
- 營業時間（useBusinessHours，rsvpHours）
- 設施容量和可用性
- 所請求時段現有的預約

**FR-RSVP-004：** 當啟用時，系統必須支援預付費預約：

- 如果 `prepaidRequired` 為 true，客戶必須登入（需要身份驗證）
- 客戶必須在預約確認前支付 `prepaidAmount`
- `prepaidAmount` 可以指定為：
  - 金額（貨幣值，例如：$50.00）
  - 客戶點數金額（點數/積分值，例如：100 點）
- 可以使用現有客戶點數（`CustomerCredit` 資料庫表）進行支付
- 如果客戶點數不足，客戶必須充值點數或購買產品以補充點數
- 透過 `alreadyPaid` 標記追蹤支付狀態
- 預付費時，預約透過 `orderId` 連結到訂單
- 當使用客戶點數支付預付費預約時，客戶點數餘額會被扣除

**FR-RSVP-005：** 系統必須分配預約狀態：

- 預設狀態：0（待處理）
- 狀態值（RsvpStatus 枚舉）：
  - `0` = Pending（待確認/尚未付款）- 預約建立時的初始狀態
  - `10` = AlreadyPaid（已付款）- 已收到付款
  - `20` = StoreConfirmed（店家已確認預約）- 店家已確認預約
  - `30` = CustomerConfirmed（客戶已確認預約）- 客戶已確認預約
  - `40` = Seated（已帶位）- 客戶已就座/到達
  - `50` = Completed（已完成）- 預約/服務已完成
  - `60` = Cancelled（已取消）- 預約已取消
  - `70` = NoShow（未到）- 客戶未到

**FR-RSVP-006：** 系統必須支援雙重確認：

- `confirmedByStore`：店面員工或管理員已確認預約
- `confirmedByCustomer`：客戶已確認預約

#### 3.1.2 員工建立的預約

**FR-RSVP-007：** 店員和店長必須能夠透過員工介面為客戶新增預約。

**FR-RSVP-008：** 員工建立的預約必須支援線上預約中所有可用的欄位。

**FR-RSVP-009：** 店員和店長必須能夠為員工建立的預約標記來源識別碼（例如：電話、當面要求、臨時到店）。

**FR-RSVP-010：** 店員和店長必須能夠透過員工介面為同一客戶新增多筆預約。系統必須支援重複預約模式（例如：每週三下午 3 點，重複 10 次）。

---

### 3.2 預約管理

#### 3.2.1 客戶自助服務

**FR-RSVP-012：** 客戶必須能夠查看他們的預約：

- 透過他們的帳號儀表板（如果已登入）
- 透過預約確認連結（用於匿名預約）

**FR-RSVP-013：** 客戶必須能夠修改預約：

- 更改日期/時間（受可用性和取消政策限制）
- 更新參與人數
- 更新特殊要求/備註
- 在允許的取消時間範圍內（`cancelHours`）進行修改

**FR-RSVP-014：** 客戶必須能夠取消預約：

- 如果在預約時間前 `cancelHours` 內，可自助取消
- 如果在允許的時間範圍外，則無法取消（當 `canCancel` 為 true 且適用時間限制時）
- 透過配置的通知管道發送取消確認

**FR-RSVP-015：** 客戶必須能夠確認他們的預約：

- 回應店面的確認請求
- 設定 `confirmedByCustomer` 標記

**FR-RSVP-015a：** 客戶必須能夠提供簽名：

- 客戶簽署預約的電子簽名介面
- 可以透過觸控螢幕、滑鼠或手寫筆擷取簽名
- 簽名會被儲存並與預約關聯
- 在預約確認前可能需要簽名（可由店面配置）

#### 3.2.2 預約管理（店員和店長）

**FR-RSVP-016：** 店員和店長必須能夠查看所有預約：

- 每日檢視（按日期）
- 依狀態過濾（Pending、AlreadyPaid、StoreConfirmed、CustomerConfirmed、Seated、Completed、Cancelled、NoShow）
- 依設施過濾
- 依客戶姓名、電子郵件或電話搜尋

**FR-RSVP-017：** 店員和店長必須能夠編輯預約：

- 修改日期/時間
- 更改參與人數
- 新增/編輯特殊要求
- 更新客戶聯絡資訊

**FR-RSVP-018：** 店員和店長必須能夠確認預約：

- 手動確認預約（`confirmedByStore = true`）
- 向客戶發送確認通知

**FR-RSVP-019：** 店員和店長必須能夠標記預約狀態：

- 當客戶到達時標記為「已就座」（記錄 `arriveTime`）
- 如果客戶未到達則標記為「未到」
- 服務完成後標記為「已完成」
- 取消預約（附原因追蹤）
- 如果已提供，查看客戶簽名

**FR-RSVP-020：** 店長必須能夠覆蓋取消限制（店員存取可由店長配置）：

- 在正常取消時間範圍外取消預約
- 必要時覆蓋預付費要求

---

### 3.3 資源管理（設施/預約時段）

**注意：** 「設施」一詞在本節中為通用用法。根據業務類型，「設施」可能代表：

- 餐桌（餐廳）
- 服務站（沙龍、水療中心）
- 治療室（診所、醫療診所）
- 諮詢室（專業服務）
- 設備或設施（健身中心、工作室）
- 任何其他可預訂的資源

#### 3.3.1 資源配置

**FR-RSVP-022：** 店長必須能夠建立和管理資源（設施/預約時段）：

- 設施名稱（facilityName，唯一）
- 設施容量（capacity，預設值：2）
- 將設施連結到店面（storeId）

**FR-RSVP-023：** 店員和店長必須能夠查看資源狀態：

- 可用資源（設施/預約時段）
- 已預訂資源及其預約詳情
- 使用中的資源（目前正在使用/已就座）

**FR-RSVP-024：** 系統必須自動檢查資源可用性：

- 驗證容量是否符合參與人數（成人 + 兒童）或服務要求
- 防止同時段重複預訂相同資源
- 在顯示可用性時考慮資源容量

#### 3.3.2 資源分配

**FR-RSVP-025：** 系統必須支援自動資源分配：

- 根據參與人數或服務要求分配可用資源
- 考慮資源容量和預約時間

**FR-RSVP-026：** 系統必須支援手動資源分配：

- 店員和店長可以手動分配特定資源
- 需要時覆蓋自動分配

---

### 3.4 RSVP 設定

#### 3.4.1 基本設定

**FR-RSVP-027：** 店長必須能夠啟用/停用 RSVP 系統：

- 切換 `acceptReservation` 以開啟/關閉系統
- 停用時，不接受新預約

**FR-RSVP-028：** 店長必須能夠配置營業時間：

- 使用店面的一般營業時間（`useBusinessHours = true`）
- 設定自訂 RSVP 時間（`rsvpHours`，格式：「09:00-18:00」）
- 定義可用的預約時段

#### 3.4.2 預付費設定

**FR-RSVP-029：** 店長必須能夠配置預付費要求：

- 啟用/停用預付費要求（`prepaidRequired`）
- 設定預付費金額（`prepaidAmount`），可以指定為：
  - 金額（貨幣值）
  - 客戶點數金額（點數/積分值）
- 要求在預約確認前支付

#### 3.4.3 取消設定

**FR-RSVP-030：** 店長必須能夠配置取消政策：

- 啟用/停用客戶取消（`canCancel`）
- 設定取消時間範圍（小時）（`cancelHours`，預設值：24）
- 定義客戶不再能取消的時間

#### 3.4.4 提醒設定

**FR-RSVP-031：** 店長必須能夠配置提醒通知：

- 設定預約前提醒時間（小時）（`reminderHours`，預設值：24）
- 啟用/停用提醒管道：
  - 簡訊提醒（`useReminderSMS`）
  - LINE 提醒（`useReminderLine`）
  - 電子郵件提醒（`useReminderEmail`）

#### 3.4.5 日曆整合

**FR-RSVP-032：** 店長必須能夠啟用日曆同步：

- Google 日曆同步（`syncWithGoogle`）
- Apple 日曆同步（`syncWithApple`）
- 為預約自動建立活動

#### 3.4.7 Google Maps 整合設定

**FR-RSVP-033：** 店長必須能夠配置 Reserve with Google 整合：

- 啟用/停用 Reserve with Google 整合
- 將店面的 Google 商家檔案連結到預約系統
- 配置 Reserve with Google API 憑證（API 金鑰、服務帳號、OAuth 令牌）
- 為 Reserve with Google 設定店面位置和商家資訊
- 將店面設施對應到 Reserve with Google 預約時段
- 查看 Reserve with Google 整合狀態和同步健康狀態
- 測試並驗證與 Reserve with Google 服務的連線

#### 3.4.8 簽名設定

**FR-RSVP-034：** 店長必須能夠配置簽名要求：

- 啟用/停用預約簽名要求
- 要求在預約確認前簽名
- 要求在報到/到達時簽名
- 安全地儲存簽名資料與預約記錄

---

### 3.5 候補名單管理

#### 3.5.1 候補名單建立

**FR-RSVP-035：** 當沒有可用時間時，客戶必須能夠加入候補名單：

- 選擇期望的日期/時間
- 提供聯絡資訊
- 收到候補名單確認

**FR-RSVP-036：** 系統必須在以下情況自動將客戶新增到候補名單：

- 請求的時段已完全預訂
- 沒有適合參與人數的可用設施

#### 3.5.2 候補名單管理

**FR-RSVP-037：** 店員和店長必須能夠查看候補名單：

- 查看所有候補名單項目
- 依日期/時間過濾
- 查看客戶聯絡資訊

**FR-RSVP-038：** 店員和店長必須能夠確認候補名單項目：

- 當有可用時間時，手動將候補名單轉換為預約
- 當候補名單請求可以確認時通知客戶
- 自動確認選項（未來增強功能）

---

### 3.6 通知系統

#### 3.6.1 確認通知

**FR-RSVP-039：** 系統必須在建立預約時立即發送確認通知：

- 螢幕上確認訊息
- 電子郵件確認（如果提供了電子郵件）
- 簡訊確認（如果啟用了 `useReminderSMS` 且提供了電話）
- LINE 通知（如果啟用了 `useReminderLine` 且連結了 LINE 帳號）

**FR-RSVP-040：** 確認通知必須包括：

- 預約日期和時間
- 參與人數（成人和兒童）
- 設施分配（如果已分配）
- 店面聯絡資訊
- 取消政策
- 日曆連結（如果啟用了日曆同步）

#### 3.6.2 提醒通知

**FR-RSVP-041：** 系統必須發送提醒通知：

- 在配置的預約前時間（`reminderHours`）
- 透過啟用的管道（簡訊、LINE、電子郵件）
- 包括預約詳情和確認請求

**FR-RSVP-042：** 系統必須支援多個提醒時間：

- 主要提醒（預設：24 小時前）
- 次要提醒（未來：2 小時前，如果已配置）

#### 3.6.3 更新通知

**FR-RSVP-043：** 當預約被修改時，系統必須通知客戶：

- 日期/時間變更
- 設施重新分配
- 狀態變更（已確認、已取消等）

**FR-RSVP-044：** 當預約被取消時，系統必須通知客戶：

- 由客戶（自助取消確認）
- 由店面（如有適用，附原因取消通知）

---

### 3.7 黑名單管理（僅店長）

#### 3.7.1 黑名單配置

**FR-RSVP-045：** 店長必須能夠管理客戶黑名單（不允許店員存取）：

- 將用戶新增到黑名單（`RsvpBlacklist`）
- 從黑名單移除用戶
- 查看黑名單項目

**FR-RSVP-046：** 系統必須防止黑名單用戶建立預約：

- 在允許建立預約前檢查黑名單
- 向黑名單用戶顯示適當訊息
- 記錄黑名單檢查嘗試

#### 3.7.2 黑名單原因

**FR-RSVP-047：** 店長必須能夠追蹤黑名單原因：

- 未到歷史記錄
- 取消濫用
- 政策違規
- 由店長手動新增

---

### 3.8 標籤管理（僅店長）

#### 3.8.1 客戶標籤

**FR-RSVP-048：** 店長必須能夠建立和管理客戶標籤（不允許店員存取）：

- 建立每店面唯一名稱的標籤（`RsvpTag`）
- 將標籤分配給預約/客戶
- 使用標籤進行客戶分群和溝通

**FR-RSVP-049：** 標籤範例：

- VIP 客戶
- 常客
- 特殊飲食要求
- 偏好的座位區域

#### 3.8.2 標籤使用

**FR-RSVP-050：** 店長必須能夠依標籤過濾預約（店員可以查看標籤但無法建立/管理）：

- 查看具有特定標籤的所有預約
- 依標籤分組客戶以進行目標溝通

---

### 3.9 整合需求

#### 3.9.1 Reserve with Google 整合

**FR-RSVP-051：** 系統必須連線並整合「Reserve with Google」服務：

- 建立與 Reserve with Google API 的連線
- 驗證並授權店面的 Google 商家檔案
- 將店面的預約系統連結到 Reserve with Google 平台
- 讓客戶能夠直接透過 Google 搜尋和 Google Maps 進行預約
- 確保透過 Reserve with Google 建立的預約出現在系統的預約管理介面中

**FR-RSVP-051a：** 系統必須支援 Reserve with Google 整合功能：

- 將預約可用性同步到 Reserve with Google
- 接受從 Reserve with Google 發起的預約
- 處理來自 Reserve with Google 的預約修改
- 處理來自 Reserve with Google 的取消
- 系統與 Reserve with Google 之間的雙向預約資料同步
- 即時可用性更新發送到 Reserve with Google

**FR-RSVP-052：** 系統必須支援來自 Google Maps 的深層連結：

- 從 Google Maps 到達時預填店面內容
- 維護預約來源追蹤
- 從 Google Maps 重新導向時保留客戶資訊
- 支援從 Google Maps 深層連結直接建立預約

**FR-RSVP-052a：** 系統必須支援 Reserve with Google API 配置：

- 店長可以啟用/停用 Reserve with Google 整合
- 將店面的 Google 商家檔案連結到預約系統
- 配置 Reserve with Google API 憑證和身份驗證
- 為 Reserve with Google 設定店面位置和商家資訊
- 將店面設施對應到 Reserve with Google 預約時段
- 驗證連線狀態和整合健康狀態

**FR-RSVP-052b：** 系統必須處理 Reserve with Google 預約 webhook：

- 接收來自 Reserve with Google 的預約建立通知
- 接收來自 Reserve with Google 的預約更新通知
- 接收來自 Reserve with Google 的預約取消通知
- 處理和驗證來自 Reserve with Google 的 webhook 負載
- 根據 Reserve with Google 事件更新本地預約記錄
- 處理 webhook 身份驗證和安全性

**FR-RSVP-052c：** 系統必須顯示 Reserve with Google 整合狀態：

- 顯示 Reserve with Google 整合是否已啟用
- 顯示與 Google 商家檔案的連線狀態
- 顯示同步狀態（活動中、錯誤、已斷線）
- 顯示最後成功同步的時間戳記
- 如果同步失敗，提供錯誤訊息
- 顯示整合健康指標

#### 3.9.2 LINE 整合

**FR-RSVP-053：** 系統必須支援 LINE Login：

- 允許客戶透過 LINE 進行身份驗證
- 將 LINE 帳號連結到用戶檔案
- 從 LINE 檔案分享聯絡資訊

**FR-RSVP-054：** 系統必須支援 LINE 通知：

- 透過 LINE 官方帳號發送確認
- 透過 LINE 訊息發送提醒
- 透過 LINE 發送更新和取消

**FR-RSVP-055：** 系統必須支援 LINE 廣播訊息：

- 店員和店長可以向候補名單客戶發送訊息
- 向已確認的預約廣播當日更新

---

### 3.10 報表和統計（僅店長）

#### 3.10.1 預約統計

**FR-RSVP-056：** 店長必須能夠查看預約統計（不允許店員存取）：

- 依日期範圍的總預約數
- 依狀態的預約數
- 利用率（已就座 vs 已確認）
- 未到率
- 取消率

#### 3.10.2 客戶分析

**FR-RSVP-057：** 店長必須能夠查看客戶歷史記錄（不允許店員存取）：

- 每位客戶的預約歷史記錄
- 造訪頻率
- 平均參與人數
- 偏好的時間/日期

#### 3.10.3 資源利用率

**FR-RSVP-058：** 店長必須能夠查看資源利用率（不允許店員存取）：

- 資源佔用率
- 最常用/最少使用的資源
- 高峰時段分析

---

## 4. 資料需求

### 4.1 預約資料模型

**FR-RSVP-059：** 系統必須儲存以下預約資料：

- 唯一預約 ID
- 店面 ID
- 用戶 ID（選填，適用於已登入用戶）
- 訂單 ID（如果預付費）
- 設施 ID（如果已分配）
- 成人人數
- 兒童人數
- 預約日期/時間（rsvpTime）
- 到達時間（arriveTime，就座時）
- 狀態（Pending、AlreadyPaid、StoreConfirmed、CustomerConfirmed、Seated、Completed、Cancelled、NoShow）
- 特殊要求/訊息
- 確認標記（由店面和客戶）
- 支付狀態（alreadyPaid）
- 支付方式（點數、替代支付）
- 客戶簽名（如果已提供，儲存為圖片/資料）
- 簽名時間戳記（擷取簽名時）
- 建立和更新時間戳記

**注意：** 當使用客戶點數進行預付費預約時，系統必須參考 `CustomerCredit` 表來檢查餘額並扣除金額。

### 4.2 設定資料模型

**FR-RSVP-060：** 系統必須為每個店面儲存 RSVP 設定：

- 接受預約標記
- 預付費要求和金額（可以是金額或客戶點數金額）
- 取消政策（啟用、小時）
- 營業時間配置
- 提醒設定（小時、管道）
- 日曆同步偏好
- Reserve with Google 整合設定（啟用/停用、API 憑證、Google 商家檔案連線、同步狀態）
- 簽名要求（啟用、確認前要求、報到時要求）

### 4.3 資源資料模型（設施/預約時段）

**FR-RSVP-061：** 系統必須儲存資源資訊（設施/預約時段）：

- 唯一資源 ID
- 店面 ID
- 資源名稱（唯一，在資料庫中儲存為 facilityName）
- 容量（人數/座位數或服務容量）

### 4.4 客戶點數資料模型

**FR-RSVP-062：** 系統必須儲存客戶點數資訊：

- 唯一點數記錄 ID
- 店面 ID
- 用戶 ID
- 點數餘額（Decimal，預設值：0）
- storeId + userId 組合的唯一約束
- 更新時間戳記

**注意：** 客戶點數是店面特定的。每位客戶可以在不同店面擁有不同的點數餘額。

---

## 5. 業務規則

### 5.1 可用性規則

**BR-RSVP-001：** 只能在配置的營業時間內建立預約。

**BR-RSVP-002：** 無法為過去的日期/時間建立預約。

**BR-RSVP-003：** 資源容量必須能夠容納參與人數（成人 + 兒童）或服務要求。

**BR-RSVP-004：** 同一資源無法在同一時間重複預訂。

### 5.2 取消規則

**BR-RSVP-005：** 客戶只能在配置的取消時間範圍內（預約時間前 `cancelHours` 小時）取消。

**BR-RSVP-006：** 如果 `canCancel` 為 false，客戶無法自助取消（必須由店員或店長取消）。

**BR-RSVP-007：** 店員和店長可以隨時取消預約，無論取消政策如何。

### 5.3 預付費規則

**BR-RSVP-008：** 如果 `prepaidRequired` 為 true，客戶必須登入（需要身份驗證）才能建立預約。

**BR-RSVP-009：** 如果 `prepaidRequired` 為 true，在收到支付之前預約不會確認。

**BR-RSVP-010：** 預付費金額（可以指定為金額或客戶點數金額）必須在預約時間前支付。

**BR-RSVP-010a：** 客戶可以使用 `CustomerCredit` 表中的現有點數支付預付費金額。

**BR-RSVP-010b：** 如果客戶點數不足以支付預付費金額，客戶必須充值點數或購買產品以補充點數。

**BR-RSVP-010c：** 當使用客戶點數進行預付費預約時，必須在預約確認時立即扣除點數餘額。

**BR-RSVP-011：** 預付費取消的退款政策遵循店面的退款政策。

### 5.4 確認規則

**BR-RSVP-012：** 預約需要店面和客戶雙方確認（雙重確認）。

**BR-RSVP-013：** 店面可以在建立時立即確認預約。

**BR-RSVP-014：** 當店面請求時，客戶必須確認預約。

### 5.5 黑名單規則

**BR-RSVP-015：** 黑名單用戶無法建立新預約。

**BR-RSVP-016：** 來自黑名單用戶的現有預約在取消前仍然有效。

**BR-RSVP-017：** 黑名單是店面特定的（在一間店面被列入黑名單的用戶仍然可以在其他店面預約）。

### 5.6 簽名規則

**BR-RSVP-018：** 如果在確認前需要簽名，在提供簽名之前無法確認預約。

**BR-RSVP-019：** 如果在報到時需要簽名，客戶必須在到達時提供簽名。

**BR-RSVP-020：** 簽名資料必須安全儲存並與預約記錄關聯。

**BR-RSVP-021：** 店員和店長可以查看客戶簽名以進行驗證。

### 5.5 Reserve with Google 整合規則

**BR-RSVP-022：** 系統必須建立並維持與 Reserve with Google 服務的活動連線。

**BR-RSVP-023：** 從 Reserve with Google 建立的預約必須使用來源識別碼進行追蹤。

**BR-RSVP-024：** 當啟用 Reserve with Google 整合時，必須即時同步預約可用性。

**BR-RSVP-025：** 在 Reserve with Google 中修改的預約必須在配置的同步間隔內反映在系統中。

**BR-RSVP-026：** 如果 Reserve with Google 同步失敗，系統必須繼續透過其他管道接受預約。

**BR-RSVP-027：** Reserve with Google 預約必須遵循與常規預約相同的業務規則（預付費要求、取消政策等）。

**BR-RSVP-028：** 系統必須優雅地處理 Reserve with Google 連線失敗，並向店長提供清晰的錯誤訊息。

---

## 6. 使用者介面需求

### 6.1 裝置/平台需求

**UI-RSVP-001：** 系統必須支援以下裝置類型：

- **客戶介面：**
  - 手機（主要平台）
  - 必須針對手機螢幕尺寸和觸控互動進行最佳化
  
- **員工/店長介面：**
  - 平板（主要平台）
  - 手機（次要平台）
  - 必須針對平板和手機螢幕尺寸進行最佳化
  - 兩種裝置類型的觸控友善介面

### 6.2 客戶端介面

**UI-RSVP-002：** 預約表單必須直觀且適合手機使用（針對手機最佳化）。

**UI-RSVP-003：** 可用性日曆必須清楚顯示可用時段（針對手機顯示最佳化）。

**UI-RSVP-004：** 確認頁面必須清楚顯示所有預約詳情（針對手機顯示最佳化）。

**UI-RSVP-005：** 預約管理頁面必須允許輕鬆修改和取消（針對手機顯示最佳化）。

**UI-RSVP-005a：** 簽名介面必須友善且易於使用：

- 支援觸控螢幕輸入（手機的主要方式）
- 提供適合手機螢幕尺寸的清晰簽名區域
- 允許客戶清除並重新簽名（如需要）
- 在擷取後顯示簽名預覽
- 針對手機裝置最佳化
- 提供清晰的簽名擷取說明

### 6.3 店員和店長介面

**UI-RSVP-006：** 預約儀表板必須提供清晰的每日/每週檢視（針對平板和手機最佳化）- 店員和店長可存取。

**UI-RSVP-007：** 預約清單必須支援過濾和搜尋（針對平板和手機最佳化）- 店員和店長可存取。

**UI-RSVP-008：** 資源檢視必須顯示目前狀態和分配（設施/預約時段）（針對平板和手機最佳化）- 店員和店長可存取。

**UI-RSVP-009：** 設定頁面必須依功能區域組織（基本、預付費、取消、提醒等）（針對平板和手機最佳化）- 僅店長。

**UI-RSVP-010：** 員工介面必須觸控友善，並支援平板和手機的直向和橫向方向 - 店員和店長可存取。

**UI-RSVP-013：** 員工介面必須提供重複預約建立功能，允許店員和店長指定：

- 基本預約詳情（客戶、參與人數、設施偏好等）
- 重複模式（例如：每週、每兩週、每月）
- 星期幾和時間
- 發生次數或結束日期
- 所有重複預約必須建立為個別預約記錄（針對平板和手機最佳化）。

**UI-RSVP-011：** 分析和報表頁面必須清楚標記為僅店長（針對平板和手機最佳化）。

**UI-RSVP-012：** 黑名單和標籤管理頁面必須清楚標記為僅店長（針對平板和手機最佳化）。

**UI-RSVP-014：** Reserve with Google 整合設定頁面必須允許店長：

- 啟用/停用 Reserve with Google 整合
- 連線店面的 Google 商家檔案
- 安全地配置 API 憑證
- 測試與 Reserve with Google 服務的連線
- 查看整合狀態和同步健康狀態
- 將設施對應到 Reserve with Google 預約時段
- 查看錯誤日誌和同步歷史記錄（針對平板和手機最佳化）。

---

## 7. 效能需求

### 7.1 回應時間

**PERF-RSVP-001：** 預約建立必須在 3 秒內完成。

**PERF-RSVP-002：** 可用性檢查必須在 1 秒內回應。

**PERF-RSVP-003：** 預約清單載入必須在 2 秒內完成每日檢視。

### 7.2 可擴展性

**PERF-RSVP-004：** 系統必須支援每個店面每天至少 1000 筆預約。

**PERF-RSVP-005：** 系統必須處理來自多個用戶的並發預約建立。

---

## 8. 安全性需求

### 8.1 存取控制

**SEC-RSVP-001：** 店員和店長可以存取店面預約管理。店員擁有操作權限（查看、建立、編輯預約）。店長擁有完整的管理存取權限，包括設定配置。

**SEC-RSVP-001a：** 店員對某些功能的存取（例如：覆蓋取消限制、查看分析）可由店長配置。

**SEC-RSVP-002：** 客戶只能查看/修改自己的預約。

**SEC-RSVP-003：** 匿名預約需要確認連結才能存取。

### 8.2 資料保護

**SEC-RSVP-004：** 客戶聯絡資訊必須受到保護，不得向未授權用戶公開。

**SEC-RSVP-005：** 支付資訊必須安全處理（如果儲存則需符合 PCI 規範）。

**SEC-RSVP-006：** 客戶簽名資料必須安全儲存並加密。

**SEC-RSVP-007：** 簽名資料只能由授權的店員、店長和提供簽名的客戶存取。

---

## 9. 錯誤處理

### 9.1 驗證錯誤

**ERR-RSVP-001：** 系統必須在建立預約前驗證所有必填欄位。

**ERR-RSVP-002：** 系統必須為驗證失敗顯示清晰的錯誤訊息。

**ERR-RSVP-003：** 當沒有可用時間時，系統必須防止建立預約。

### 9.2 系統錯誤

**ERR-RSVP-004：** 系統必須優雅地處理並發預約衝突。

**ERR-RSVP-005：** 系統必須記錄所有預約操作以進行稽核追蹤。

**ERR-RSVP-006：** 系統必須優雅地處理通知失敗（重試機制）。

---

## 10. 未來增強功能（不在範圍內）

### 10.1 進階功能

- 自動化設施分配最佳化
- 客戶忠誠度計劃整合
- POS 系統整合
- 進階分析和報表儀表板
- 多語言支援（超出目前的 i18n）
- 自動化候補名單確認
- 進階重複預約模式（自訂排程、例外）
- 群組預約管理
- 預約押金/未到費用收取

---

## 11. 依賴關係

### 11.1 外部服務

- 電子郵件服務提供商（用於電子郵件通知）
- 簡訊服務提供商（用於簡訊通知）
- LINE Messaging API（用於 LINE 通知）
- Reserve with Google API（用於 Google 整合）
- 支付處理（用於預付費預約）

### 11.2 內部系統

- 用戶身份驗證系統
- 店面管理系統
- 訂單管理系統（用於預付費預約）
- 通知佇列系統

---

## 12. 驗收標準

### 12.1 核心功能

- ✅ 客戶可以建立線上預約
- ✅ 店員和店長可以透過員工介面為客戶建立預約
- ✅ 店員和店長可以為同一客戶建立多筆重複預約（例如：每週三下午 3 點，重複 10 次）
- ✅ 可以查看、編輯和取消預約
- ✅ 設施分配正確運作
- ✅ 透過配置的管道發送通知
- ✅ 可以配置和儲存設定
- ✅ 黑名單防止被列入黑名單的用戶預約

### 12.2 整合

- ✅ Reserve with Google 整合正常運作（如果已啟用）
- ✅ 建立並維持與 Reserve with Google 服務的連線
- ✅ LINE 整合正常運作（如果已啟用）
- ✅ 日曆同步正常運作（如果已啟用）

### 12.3 效能

- ✅ 滿足所有效能需求
- ✅ 系統處理預期負載

---

## 13. 詞彙表

- **RSVP**：預約/約會（Répondez s'il vous plaît，敬請回覆）
- **Prepaid（預付費）**：預約確認前需要支付
- **Waitlist（候補名單）**：等待可用時間的客戶佇列
- **Blacklist（黑名單）**：被阻止進行預約的用戶清單
- **Dual Confirmation（雙重確認）**：店面和客戶都必須確認預約
- **No-show（未到）**：未到達預約/約會的客戶
- **Walk-in（臨時到店）**：沒有預約就到達的客戶
- **Facility/Resource（設施/資源）**：可預訂資源的通用術語。對於餐廳而言，這指的是餐桌。對於其他企業（沙龍、診所等），這可能指服務站、治療室、諮詢室或其他可預訂的資源。
- **Seated（已就座）**：表示客戶已到達且服務已開始的通用術語。對於餐廳而言，這表示在設施處就座。對於其他企業，這可能表示「已到達」或「服務已開始」。

---

## 14. 修訂歷史

| 版本 | 日期 | 作者 | 變更 |
|------|------|------|------|
| 1.5 | 2025-01-27 | 系統 | 新增對 Reserve with Google 服務連線的明確需求。更新所有從「Google Maps Reserve」到「Reserve with Google」的引用以提升清晰度。增強整合需求以強調連線建立和 Google 商家檔案連結。 |
| 1.4 | 2025-01-27 | 系統 | 新增全面的 Google Maps 整合需求，包括 Reserve API 整合、webhook 處理、配置設定、狀態監控和業務規則。新增第 3.4.7 節 Google Maps 整合設定。 |
| 1.3 | 2025-01-27 | 系統 | 將店長和店員分離為具有不同存取層級的獨立角色。新增存取控制摘要部分。更新所有需求以指定哪個角色可以存取哪些功能。 |
| 1.2 | 2025-01-27 | 系統 | 將文件中的術語從「table」更改為「facility」以更好地反映通用可預訂資源 |
| 1.1 | 2025-01-27 | 系統 | 更新為業務無關：澄清 RSVP 系統可用於任何業務類型（不僅僅是餐廳），新增「設施」和「已就座」的通用術語說明，更新資源管理術語 |
| 1.0 | 2025-01-27 | 系統 | 初始功能需求文件 |

---

## 文件結束
